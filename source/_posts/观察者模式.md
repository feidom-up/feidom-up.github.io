---
title: 设计模式-观察者模式
date: 2020-08-12 09:24:58
tags: 设计模式
categories: 设计模式
---
### 简单介绍一下
观察者模式，又称**发布/订阅模式**，它定义了一种**一对多**的关系，让多个观察者对象同时监听某一个主题对象，这个主题对象的状态发生变化时就会通知所有的观察者对象，使得它们能够自动更新自己。

### 使用观察者模式的好处：
* 支持简单的广播通信，自动通知所有已经订阅过的对象。
* 页面载入后目标对象很容易与观察者存在一种动态关联，增加了灵活性。
* 目标对象与观察者之间的抽象耦合关系能够单独扩展以及重用。

### 用javaScript实现一般简单的观察者模式
*pub(Publish) 发布*
*sub(Subscribe) 订阅*
*dep 发布订阅中心-电话本*

```javascript
    var dep = {};  // dep相当于电话本，所有订阅者都注册在这里
    (function (q) {
        var topics = {}, // 回调函数存放的数组
            subUid = -1;
        // 发布方法
        q.publish = function (topic, args) {
            if (!topics[topic]) {
                return false;
            }
            setTimeout(function () {
                var subscribers = topics[topic],
                    len = subscribers ? subscribers.length : 0;

                while (len--) {
                    // 遍历所有订阅的方法，全部执行
                    subscribers[len].func(topic, args);
                }
            }, 0);

            return true;

        };
        // 订阅方法
        // @param  topic  订阅者名称
        // @param  func   订阅方法，通知时，调用这个方法实现通知
        q.subscribe = function (topic, func) {
            if (!topics[topic]) {
                // 注册观察对象
                topics[topic] = [];
            }
            var token = (++subUid).toString();   // 方法的唯一口令标识，退订时可用
            // 注册观察方法
            topics[topic].push({
                token: token,
                func: func
            });
            return token;
        };
        //退订方法
        q.unsubscribe = function (token) {
            for (var m in topics) {
                if (topics[m]) {
                    for (var i = 0, j = topics[m].length; i < j; i++) {
                        if (topics[m][i].token === token) {
                            // 根据唯一口令标识 移除观察方法，实现退订
                            topics[m].splice(i, 1);
                            return token;
                        }
                    }
                }
            }
            return false;
        };
    } (dep));

```

使用上面这个观察者模式

```javascript
    // 来，订阅一个
    pubsub.subscribe('example1', function (topics, data) {
        // 通知时，这个方法收到通知执行
        console.log(topics + ": " + data);
    })
    // 再加一个订阅方法
    pubsub.subscribe('example1', function (topics, data) {
        // 这个方法也收到通知执行
        if(!Array.isArray(data)){
            console.log('接到通知2',topics,  data)
        }
    })
    //发布通知
    pubsub.publish('example1', 'hello world!');
    pubsub.publish('example1', ['test', 'a', 'b', 'c']);
    pubsub.publish('example1', [{ 'color': 'blue' }, { 'text': 'hello'}]);
```
### 一张图说清楚观察者模式
![观察者模式](http://i.feidom.com/sub_pub%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F.png)

### 特别鸣谢
此篇笔记是看了[汤姆大叔的博客-深入理解JavaScript系列（32）：设计模式之观察者模式](https://www.cnblogs.com/TomXu/archive/2012/03/02/2355128.html),笔记内容大多来自该篇博客。大叔的博客中还有其他观察者模式的实现方式，如需更深的理解，请移步。