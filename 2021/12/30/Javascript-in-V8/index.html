<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <title>
        Javascript-in-V8 |
        
        FEIDOM
    </title>
    <link rel="shortcut icon" href="/images/logo.jpg">
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.0.4/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"feidom-up.github.io","root":"/","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":false,"number":true,"expand_all":true},"style":{"primary_color":"#0066CC","avatar":"/images/logo.jpg","favicon":"/images/logo.jpg","img_position":"left","left_side_width":"260px","content_max_width":"900px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"你问我买不买得起全套的喜羊羊，我的奖学金可以洒满黄浦江。"}},"local_search":{"enable":true,"trigger":"auto","unescape":false,"preload":false},"version":"3.0.4"};
    KEEP.language = {"search":"搜索...","prev":"上一页","next":"下一页","prev_posts":"上一篇","next_posts":"下一篇","page":"第 %d 页","recent_posts":"最新文章","share":"分享","powered_by":"由 %s 驱动","theme":"主题","rss_feed":"RSS Feed","category":"分类","categories":"分类","tag":"标签","tags":"标签","tagcloud":"标签云","comment":"评论","home":"首页","archive":"归档","archives":"归档","about":"关于","site_uv":"访问人数","site_pv":"总访问量","links":"友链","link":"友链","top":"顶置","read_more":"阅读全文","wordcount":"字","min2read":"分钟","changelog":"更新日志","copyright":{"title":"本文标题","author":"本文作者","link":"本文链接","create_time":"创建时间","license_title":"版权声明","license_content":"本博客所有文章为作者学习笔记，有转载其他前端大佬的文章。转载时请注明出处。"},"ago":{"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 月前","year":"%s 年前"}};
  </script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="feidom up up up" type="application/atom+xml">
</head>


<body>
<div class="page-container">

    

    <header class="page-header">
        <div class="header-progress"></div>
    </header>

    <main class="page-main">

        <div class="page-main-content">

            <div class="page-main-content-top">
                <header class="header-wrapper">

    <div class="header-content">
        <a class="logo-title" href="/">
            FEIDOM
        </a>

        <ul class="menu-list">
            
                <li class="menu-item">
                    <a class=""
                       href="/"
                    >
                        首页
                    </a>
                </li>
            
                <li class="menu-item">
                    <a class=""
                       href="/archives"
                    >
                        归档
                    </a>
                </li>
            
                <li class="menu-item">
                    <a class=""
                       href="/about"
                    >
                        关于
                    </a>
                </li>
            
        </ul>

        <div class="menu-bar">
            <div class="menu-bar-middle"></div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


            </div>

            <div class="page-main-content-middle">

                <main class="main-content normal-code-theme">

                    
                        <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Javascript-in-V8</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/logo.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span>乔文飞</span>
                        <span class="level">Lv8</span>
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-calendar"></i> 2021-12-30 11:05:49
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>
            <ul>
                
                    <li>
                        <a href="/categories/js%E5%8E%9F%E7%90%86/">js原理</a>
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>
            <ul>
                
                    <li>
                        <a href="/tags/js%E5%8E%9F%E7%90%86/">js原理</a>
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>之前对<a class="link"   href="http://www.feidom.com/2021/08/09/js%E5%AF%B9%E8%B1%A1%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84%E9%82%A3%E4%BA%9B%E7%89%B9%E7%82%B9/"  target="_blank" rel="noopener">js对象你不知道的那些特点<i class="fas fa-external-link-alt"></i></a> 有一些粗浅的认识，这个笔记写的很无理取闹。现在研究清楚以后，重新补一篇笔记来完善知识。之前的这篇就留着吧，也是学习和思考中一个必有的认知阶段。</p>
<h4 id="JS-Object-中的常规属性和排序属性"><a href="#JS-Object-中的常规属性和排序属性" class="headerlink" title="JS Object 中的常规属性和排序属性"></a>JS Object 中的常规属性和排序属性</h4><ul>
<li><p>常规属性(V8:properties)<br>在properties对象中，会按照创建时的顺序保存常规属性。</p>
</li>
<li><p>排序属性(V8:elements)<br>当key为数字时，会将这类属性存储在elements对象中，将其作为一块连续的内存以Array的形式进行存储。在elements对象中，会按照数字大小的顺序来存放排序属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ClassA</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">100</span>] = <span class="string">'100'</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">1</span>] = <span class="string">'1'</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="string">'B1'</span>] = <span class="string">'B'</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">50</span>] = <span class="string">'50'</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">3</span>] = <span class="string">'3'</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="string">'A2'</span>] = <span class="string">'A'</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="string">'C'</span>] = <span class="string">'C'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> ClassA();</span><br><span class="line"><span class="keyword">for</span>(key <span class="keyword">in</span> a)&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;a[key]&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line">a.qwf = <span class="string">'qwf'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(a)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ClassB</span>(<span class="params">num</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;num; i++)&#123;</span><br><span class="line">    <span class="keyword">this</span>[i] = <span class="string">`eeeeee_<span class="subst">$&#123;i&#125;</span>`</span></span><br><span class="line">    <span class="keyword">this</span>[<span class="string">`p_<span class="subst">$&#123;i&#125;</span>`</span>] = <span class="string">`pppppp_<span class="subst">$&#123;i&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> ClassB(<span class="number">20</span>);</span><br><span class="line"><span class="built_in">console</span>.log(b)</span><br></pre></td></tr></table></figure>

<p>作为两个属性，为啥在console的控制台打印的结果中没有发现呢。其实console的控制台打印的没那么深，那怎么能找到他们呢。在Memory控制台录制快照，就能很明显的看到他们。</p>
</li>
</ul>
<h4 id="V8引擎对Object做了什么残忍的事"><a href="#V8引擎对Object做了什么残忍的事" class="headerlink" title="V8引擎对Object做了什么残忍的事"></a>V8引擎对Object做了什么残忍的事</h4><ul>
<li><p>Hidden Class 隐藏类</p>
</li>
<li><p>Properties pointer 常规属性指针</p>
</li>
<li><p>Elements pointer 排序元素指针</p>
<p>为什么要这样分开呢？？？<br>首先我们需要聊一下公认最快的C语言，它的快很大程度上归功于它严格的类型约束。也就是说大型的面向对象系统都有严格的数据结构，这对快速的属性查询很关键。<br>所以，Js中的Object的定义非常差,因为它太灵活了，没有类型的概念。而且存在可以任性修改的原型链，它没有限制。<br>所以在V8对JS Object进行处理时，为了快速的属性查询，有一个内部的类型系统：对具有相同结构的对象进行分组；各个对象之间可以共享；生成的成本很高，但是之后的成本很低。</p>
</li>
</ul>
<h4 id="V8对Object做的优化"><a href="#V8对Object做的优化" class="headerlink" title="V8对Object做的优化"></a>V8对Object做的优化</h4><p>  属性内联缓存<br>  在属性查询中检查隐藏类</p>
<ol>
<li>在第一次时完全通用查询</li>
<li>然后记住你在哪个地方找到的这个属性<br>生成新的优化代码</li>
<li>下次使用，直接访问</li>
</ol>
<h4 id="Object-属性的存储"><a href="#Object-属性的存储" class="headerlink" title="Object 属性的存储"></a>Object 属性的存储</h4><ul>
<li>直接在object上，即默认状态，这个很快</li>
<li>array形式存储，也很快</li>
<li>哈希表结构（字典模式），这个的交互会慢很多<br>字典模式相比于其他模式，运行速度降低。触发字典模式的行为如下：</li>
<li>非常多的属性，他们没有办法被放在默认状态的内存中，这个数字可能是10 ？30？</li>
<li>改变属性</li>
<li>删除属性</li>
</ul>
<h4 id="JS-Array-字典模式"><a href="#JS-Array-字典模式" class="headerlink" title="JS Array 字典模式"></a>JS Array 字典模式</h4><p>  同样对比C，Js中的Array也因为没有类型约束给了用户很大的自由，也挺样带来了不可控的性能问题。<br>  连续内存的存储和hash表（字典模式）不同的存储方式，不一样的性能体验。<br>  触发字典模式的行为如下：</p>
<ol>
<li><p>非常多的属性，大于1024？ 10000？</p>
</li>
<li><p>动态扩容</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">a[<span class="number">1000</span>] = <span class="number">8</span>;</span><br><span class="line"><span class="comment">// ok</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1000</span>);</span><br><span class="line">a[<span class="number">0</span>] = <span class="string">'nihao'</span>;</span><br><span class="line">a[<span class="number">100</span>] = <span class="number">8</span>;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="结合以上特点，我们应该做什么"><a href="#结合以上特点，我们应该做什么" class="headerlink" title="结合以上特点，我们应该做什么"></a>结合以上特点，我们应该做什么</h4><p>  Js给我们很高的灵活度让我们随心所欲，但是我们不应该为所欲为，自由度高，带来的就是性能的不友好。<br>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ClassA</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">100</span>] = <span class="string">'100'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> ClassA();</span><br><span class="line">a.qwf = <span class="string">'qwf'</span>;  <span class="comment">// 这样直接添加属性，改变了隐藏类</span></span><br></pre></td></tr></table></figure><br>  所以尽量定义好默认属性，不要在构造函数之外做大量的动态属性添加和删除，尽量共享隐藏类。</p>
<h4 id="V8"><a href="#V8" class="headerlink" title="V8"></a>V8</h4><p>  <a class="link"   href="https://v8.dev/"  target="_blank" rel="noopener">V8<i class="fas fa-external-link-alt"></i></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line">The first type of attry to talk about in javascript is the TypedArray</span><br><span class="line"></span><br><span class="line">So TypedArrays are going to make a lot of aense to you if</span><br><span class="line">you are coming from a C background</span><br><span class="line"></span><br><span class="line">They are contiguous blocks of memory that are specified for a particylar data type.</span><br><span class="line"></span><br><span class="line">So you have Uint32Array, Float64Array, Unit8Array, and so on, and so forth, which actually, if you are familiar with Javascript,is sort of unusual. Because most things in Javascript have no type. </span><br><span class="line"></span><br><span class="line">So this idea that we are specifying a very specific size for our numbers id actually like pretty unique. And that&#39;s because the TypedArray specification grew up alongside the WebGL specification.</span><br><span class="line"></span><br><span class="line">And you can inagine how you need that level of specificity if you are doing graphics programming.</span><br><span class="line"></span><br><span class="line">So that&#39;s sort of where the TypedArray specification came from.</span><br><span class="line"></span><br><span class="line">But it&#39;s been adopted into other things now that it&#39;s there.</span><br><span class="line"></span><br><span class="line">So agein, they&#39;re memory efficient. You don&#39;t have to box them.</span><br><span class="line"></span><br><span class="line">They behave as you&#39;d expect.</span><br><span class="line"></span><br><span class="line">They&#39;re a very nice option for arrays.</span><br><span class="line"></span><br><span class="line">But if you can&#39;t use TypedArrays for whatever reason, you need to use Javascript Arrays.</span><br><span class="line"></span><br><span class="line">SO Javascript Array object --Array with a captital A-- has an API which is going to look a little weird to you if you are used to C-style arrays.</span><br><span class="line"></span><br><span class="line">It&#39;s going to have operations that are different.</span><br><span class="line"></span><br><span class="line">It&#39;s going to have like push and pop.</span><br><span class="line"></span><br><span class="line">It&#39;s going to allow you to index out of bounds.</span><br><span class="line"></span><br><span class="line">It&#39;s going to have just sort of odd behavior to me as somebody coming from C.</span><br><span class="line"></span><br><span class="line">So as you can imagine, because the API allows all these non-C array-like things, the backing storage in V8 is not always somethings that looks like array. There are actually two diffent types of backing storage for arrays. Thewe are sparse arrays and dense arrays, which map to either something tach looks like a C-style array. like you&#39;d expect, or a hash table. And if you array is backed by a V8 hash table, that&#39;s called being in dictionary mode, and it&#39;s considerably less efficient. It&#39;s case that you want to avoid.</span><br><span class="line"></span><br><span class="line">There are many factors in V8 that causes you to be kicked into dictionary mode or not. </span><br><span class="line"></span><br><span class="line">So it&#39;s kind of complicated to define them all. </span><br><span class="line"></span><br><span class="line">But one of them, for instance, is space efficiency.</span><br><span class="line"></span><br><span class="line">So is the codes you wrote will be three times more effcient, use three times less space if it was backed by a hash table than an array, then it&#39;ll be a hsah table on back end. So there are criteria like that. </span><br><span class="line"></span><br><span class="line">js allows you to create a new uninitialized array and then just suddenly index into it at whatever index.</span><br><span class="line"></span><br><span class="line">This, doesn&#39;t make any sense in C. It&#39;s not something you&#39;d actually do. And in V8, it will immediately trigger dictionary mode. So this, you will now have a nice, slow array to waok with, not something you want.</span><br><span class="line"></span><br><span class="line">So real simple change.</span><br><span class="line"></span><br><span class="line">All you have to do is declare how much storage you want up font.Now you have declared to V8 that you actually want an array of a certain size. V8 will back your array by a contigous array of that size, and you can go from there.</span><br><span class="line"></span><br><span class="line">Veay sensible, kind of no-brainerish, but again, Javascript allows you to do it in a way that ends up being very inefficient, so it&#39;s important to know.</span><br><span class="line"></span><br><span class="line">So that is the numeric representation and the immediate representation of objects.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------------------------------</span><br><span class="line">Object in V8 </span><br><span class="line">-------------------------------</span><br><span class="line"></span><br><span class="line">So objects in JavaScript are there very poorly defined things.</span><br><span class="line"></span><br><span class="line">They are associative arrays.</span><br><span class="line"></span><br><span class="line">They&#39;re just bundles of key value pairs of properties.</span><br><span class="line"></span><br><span class="line">So you have string balue for key, property value.</span><br><span class="line"></span><br><span class="line">And all property values are these undefined whatevers, because Javascript doesn&#39;t have a notion of type.</span><br><span class="line"></span><br><span class="line">Object have prototype chains. You can add and remove properties anywhere at the prototype chain and on the object inself at any point. </span><br><span class="line"></span><br><span class="line">Javascript doesn&#39;t enforce any specificity or structure in your code.</span><br><span class="line"></span><br><span class="line">So if you wanted to, you could make every single object in your whole program absolutely a unique set of properties.</span><br><span class="line"></span><br><span class="line">Nothing in Javascript will enforce structure or self-similarity.</span><br><span class="line"></span><br><span class="line">But just because JavaScript allows you to do that, you really,really shouldn&#39;t.</span><br><span class="line"></span><br><span class="line">That&#39;s actually a terrible thing to do for performance.</span><br><span class="line"></span><br><span class="line">And I&#39;ll explain why in a minute.</span><br><span class="line"></span><br><span class="line">So in V8,the V8 team looked at trying to write a large-scale application in JavaScript and thought, hey, you know what&#39;s important in large-scale systems is object-orientenness.</span><br><span class="line"></span><br><span class="line">And if you have object-orientenness in your system, then now, property access is one of the key things that you need to make fast. </span><br><span class="line"></span><br><span class="line">So V8 designed its structure to make property access on objects as efficient as it could be.</span><br><span class="line"></span><br><span class="line">So the internal representation of an object in V8 is three words.</span><br><span class="line"></span><br><span class="line">So first, we have a hidden class pointer, which is an internal notion of type, which I&#39;ll explain in a second.</span><br><span class="line"></span><br><span class="line">And then we have two pointers to different kinds of properties.</span><br><span class="line"></span><br><span class="line">We have properties that have string names and then properties that have int names. </span><br><span class="line"></span><br><span class="line">But really, the only thing that&#39;s important is your have a type, and then you have property storage.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">So waht&#39;s this hidden class thing?</span><br><span class="line"></span><br><span class="line">So hidden classes, again, ther&#39;re V8&#39;s interbal notion of type.</span><br><span class="line"></span><br><span class="line">JavaScript itself isn&#39;t going to enforce any kind of notionof type on you.</span><br><span class="line"></span><br><span class="line">BUt in order to make things effcient, V8itself need to have some sort of structure in whst it things you&#39;re doing. </span><br><span class="line"></span><br><span class="line">So it introduces a type system.</span><br><span class="line"></span><br><span class="line">And that type system froups objects with the same structure.</span><br><span class="line"></span><br><span class="line">So as you&#39;re adding properties to objects, which you can do in JavaScript, V8 will be looking at the properties on each object and mapping ta&#x3D;hat bundle of properties to a hidden class, which defines an object with exactly those properties.</span><br><span class="line"></span><br><span class="line">So, dor instance, if I have this constructor in JavaScript where I have a point, and it has an x and y, and the way those values are added by first adding x to the object and then adding y, thay&#39;s going to generate a hidden class that backs objects that are created from this function that has exactle the properties x and y.</span><br><span class="line"></span><br><span class="line">And that really seems sort of obvious.</span><br><span class="line"></span><br><span class="line">But then, the first time this function is run, that hidden class is going to be built for the first time. And then, all subsequent times this dunction is run, those new objects can share the same hidden class.So you only pay the price for building it the very first time.</span><br><span class="line"></span><br><span class="line">After that, you can just use the same object.</span><br><span class="line"></span><br><span class="line">So we went through all this trouble of building up a notion of type.</span><br><span class="line"></span><br><span class="line">So now, we have types that correspond to specifically what exact </span><br><span class="line">properties are on an object.</span><br><span class="line"></span><br><span class="line">We can use taht notion of type to make property access quick using something called inline caching.</span><br><span class="line"></span><br><span class="line">So if yoiu want to look up a property on an object in Javascript, you&#39;re going to say, I am looking for property with name x on object y.</span><br><span class="line"></span><br><span class="line">The first thing you do whrn you&#39;re trying to look up a property is check the hidden class of the object.</span><br><span class="line"></span><br><span class="line">If you&#39;re never tried to look up that property on an object of that type before, then what you&#39;re going to have to do is a fully generic search for that property.</span><br><span class="line"></span><br><span class="line">So again, we just have a bundle of properties somewhere.</span><br><span class="line"></span><br><span class="line">They all have string names.</span><br><span class="line"></span><br><span class="line">You have a string of the property you&#39;re looking for.</span><br><span class="line"></span><br><span class="line">And you&#39;re going to have to look through taht list for the property that has a matching name.</span><br><span class="line"></span><br><span class="line">That&#39;s a pretty slow operation.</span><br><span class="line"></span><br><span class="line">But once you found thst property once, you can remember the offset to it. you can remember where you found that property and use it later, which means that you can use that to generate new optimized code which specifies how you look up that particular property on that particular object.</span><br><span class="line"></span><br><span class="line">And next time you want to look up property with that name on an object of that type, you can have direct access You know exactly where to go in an object of that type.</span><br><span class="line"></span><br><span class="line">And it&#39;s much much much faster.</span><br><span class="line"></span><br><span class="line">So thst&#39;s really what the notion of having hidden class is getting us, is now we can make property access really fast through inline caching.</span><br><span class="line"></span><br><span class="line">So this is a classic example of bad idea. </span><br><span class="line"></span><br><span class="line">function Vec2(x,y)&#123;</span><br><span class="line">	this.x &#x3D; x;</span><br><span class="line">	this.y &#x3D; y;</span><br><span class="line">&#125;</span><br><span class="line">var v0 &#x3D; new  Vec2(5,8);</span><br><span class="line">v0.z &#x3D; 34;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">So I have another constructor. It&#39;s creating a vector object. </span><br><span class="line"></span><br><span class="line">But then, after I go through the trouble of doing that, I decide that I now wanted property z on this object.</span><br><span class="line"></span><br><span class="line">The problem with that is that if you add a property z to that object at some future point, if you just dynamically do that, you&#39;re going to change the hidden class of the object, which means that all this nice caching you&#39;re done and building up a notion of where the properties are, that&#39;s just blown away because now you have a new hidden class. </span><br><span class="line"></span><br><span class="line">You have to pay to build the new hidden class, and now you have to deal with a new hidden class.</span><br><span class="line"></span><br><span class="line">So one of the best things you can do to make you code efficient is to create a few well-defined types.</span><br><span class="line"></span><br><span class="line">Don&#39;t do alot of dynamic property adding and removing outside of constructors.</span><br><span class="line"></span><br><span class="line">Pretty much set things up once, have them look alike so that they can share the same hidden class, and don&#39;t mess with the properties they have.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------------------------------</span><br><span class="line">Object properties storage</span><br><span class="line">-------------------------------</span><br><span class="line"></span><br><span class="line">So now we know an object has properties.</span><br><span class="line"></span><br><span class="line">those properties can be in different storage states.</span><br><span class="line"></span><br><span class="line">So the first state ,the default, is that they can be stored directly in an array on the object.</span><br><span class="line"></span><br><span class="line">that great, that&#39;s fast. that&#39;s where you want to be. </span><br><span class="line"></span><br><span class="line">A second state they can be in is being stored in array off the objects. still great. No problem.</span><br><span class="line"></span><br><span class="line">The third case, which is the one you really have to look out for, is when they&#39;re stored in a hash table.</span><br><span class="line"></span><br><span class="line">So mush like just the array case in general where arrays can have different types of backing storage, properties can have different types of backing storage too.</span><br><span class="line"></span><br><span class="line">So properties can either be in normal mode where they&#39;re stored as an array or a dictionary mode where they&#39;re stored as a hash table. </span><br><span class="line"></span><br><span class="line">And if you have an object in dictionary mode, it&#39;s going to be mush slower to interact with.</span><br><span class="line"></span><br><span class="line">So you don&#39;t want that.</span><br><span class="line"></span><br><span class="line">So what triggers dictionary mode ,and how do you avoid it? Well, one thing that triggers itis toomany properties.</span><br><span class="line"></span><br><span class="line">So if you have so many properties that they won&#39;t fit into the internal storage for properties, then you have to have a hash table elsewhere. And that number of too many properties is somewhere around 30. It&#39;s quite generous, but you mighe hit it in some cases.</span><br><span class="line"></span><br><span class="line">The other things you can do to confuse your object and kick it into dictionary mode are to change the properties on the object.</span><br><span class="line"></span><br><span class="line">You can change the attribute, you can delete properties, that kind of thing. Those things are all going to kick you straight to dictionary mode.</span><br><span class="line"></span><br><span class="line">Again, and now you&#39;re going to make your object mush slower to interact with.</span><br></pre></td></tr></table></figure>
        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>本文标题：Javascript-in-V8</li>
        <li>本文作者：乔文飞</li>
        <li>创建时间：2021-12-30 11:05:49</li>
        <li>
            本文链接：http://www.feidom.com/2021/12/30/Javascript-in-V8/
        </li>
        <li>
            版权声明：本博客所有文章为作者学习笔记，有转载其他前端大佬的文章。转载时请注明出处。
        </li>
    </ul>
</div>

            </div>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2024/08/22/hhkb%E5%BF%AB%E6%8D%B7%E9%94%AE%E5%A4%87%E5%BF%98/"
                        >
                            <span class="left arrow-icon flex-center" >
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">hhkb快捷键备忘</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/08/09/js%E5%AF%B9%E8%B1%A1%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84%E9%82%A3%E4%BA%9B%E7%89%B9%E7%82%B9/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">js对象你不知道的那些特点</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center" >
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                    
                </main>

            </div>

            <div class="page-main-content-bottom">
                <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span> -
            
            2024 <i class="fas fa-heart icon-animate"></i> <a href="/">乔文飞</a>
        </div>
        
        <div class="theme-info info-item">
            <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备20066977号</a>
        </div>
    </div>
</footer>

            </div>
        </div>
    </main>

    <div class="sidebar-tools">
        <div class="tools-container">
    <ul class="tools-list">
        
            <li class="search popup-trigger">
                <i class="fas fa-search"></i>
            </li>
        

        

        <!-- TOC aside toggle -->
        

    </ul>
</div>

    </div>

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">

    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        <li class="tools-item tool-scroll-to-top flex-center">
            <i class="fas fa-arrow-up"></i>
        </li>

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="tools-ul-1">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

    </ul>
</div>

    </div>

    <!-- page aside -->
    <aside class="page-aside">
        
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#JS-Object-中的常规属性和排序属性"><span class="nav-number">1.</span> <span class="nav-text">JS Object 中的常规属性和排序属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#V8引擎对Object做了什么残忍的事"><span class="nav-number">2.</span> <span class="nav-text">V8引擎对Object做了什么残忍的事</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#V8对Object做的优化"><span class="nav-number">3.</span> <span class="nav-text">V8对Object做的优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Object-属性的存储"><span class="nav-number">4.</span> <span class="nav-text">Object 属性的存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JS-Array-字典模式"><span class="nav-number">5.</span> <span class="nav-text">JS Array 字典模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结合以上特点，我们应该做什么"><span class="nav-number">6.</span> <span class="nav-text">结合以上特点，我们应该做什么</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#V8"><span class="nav-number">7.</span> <span class="nav-text">V8</span></a></li></ol>
    </div>
</div>
        
    </aside>

    <!-- image viewer -->
    <div class="image-viewer-container">
    <div class="img-box">
        <img src="">
    </div>
</div>


</div>



    <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-icon">
            <i class="fas fa-search"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.0.4/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.0.4/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.0.4/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.0.4/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.0.4/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.0.4/source/js/local-search.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.0.4/source/js/left-side-toggle.js"></script>

    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.0.4/source/js/code-copy.js"></script>
    

    


</body>
</html>